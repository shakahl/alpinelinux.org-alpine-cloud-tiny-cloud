# Tiny Cloud - Instance MetaData Service functions and variables
# vim:set ft=sh ts=4 noet:

### configuration

if [ -z "$TINY_CLOUD_LIBS" ]; then
    TINY_CLOUD_CONF=${TINY_CLOUD_CONF:-/etc/conf.d/tiny-cloud}
    [ -f "$TINY_CLOUD_CONF" ] && source "$TINY_CLOUD_CONF"
    TINY_CLOUD_LIBS=${TINY_CLOUD_LIBS:-/lib/tiny-cloud}
fi

# defaults
CLOUD="${CLOUD:-unknown}"

# these are always cloud-specific

unset \
	IMDS_HEADER	\
	IMDS_QUERY \
	IMDS_URL \
	IMDS_HOSTNAME \
	IMDS_SSH_KEYS \
	IMDS_USERDATA

unset -f \
	_imds_token \
	_imds_header \
	2>/dev/null	|| true

# without error reporting or ending newline enforcement
_imds() {
	wget --quiet --header "$(_imds_header)" --output-document - \
		"$IMDS_URL/$1/$IMDS_QUERY"
}

_enforce_ending_newline() { sed '$a\'; }

imds() {
	set -o pipefail
	_imds "$1" | _enforce_ending_newline
	RV=$?
	set +o pipefail
	[ $RV != 0 ] && echo "ERROR: $RV" >&2
	return $RV
}

imds_hostname() {
	imds "$IMDS_HOSTNAME"
}

imds_userdata() {
	imds "$IMDS_USERDATA"
}

imds_ssh_keys() {
	imds "$IMDS_SSH_KEYS"
}

### load cloud-specific things

if [ ! -d "$TINY_CLOUD_LIBS/$CLOUD" ]; then
	echo "ERROR: Unknown Cloud '$CLOUD'" >&2
	exit 1
fi

source "$TINY_CLOUD_LIBS/$CLOUD/imds"
